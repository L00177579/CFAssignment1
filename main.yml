AWSTemplateFormatVersion: 2010-09-09
#This is the CloudFormation template that will deploy the companies base VPC and all required resources.

Parameters:
  VPCTemplateURL:
    Description: s3 Bucket URL for the VPC cloud formation template.
    Type: String
    Default: https://cf-templates-1ptll2eogk9j2-us-east-1.s3.amazonaws.com/vpc.yml
  SubnetTemplateURL:
    Description: s3 Bucket URL for the Subnet cloud formation template.
    Type: String
    Default: https://cf-templates-1ptll2eogk9j2-us-east-1.s3.amazonaws.com/subnet.yml
  SSHKeyJumpBox:
    Description: Name of the SSH Key Pair for the EC2 Jump Box Instance
    Type: String
    Default: SSHKey
  SSHKeyApplication:
    Description: Name of the SSH Key Pair for the EC2 Application Instance
    Type: String
    Default: SSHKey
  SSHKeyFrontEnd:
    Description: Name of the SSH Key Pair for the EC2 Front End Instance
    Type: String
    Default: SSHKey
  SSHKeyDatabase:
    Description: Name of the SSH Key Pair for the EC2 Database Instance
    Type: String
    Default: SSHKey
  EC2ImageId:
    Description: The AMI for the EC2 instances; region based. Keep entry blank to attempt to automatically apply AMI based on region.
    Type: String
    Default: ""
  EC2InstanceType:
    Description: >-
      Enter one of the default sizes: t1.micro or t2.micro. The default is set as t2.micro.
    Type: String
    Default: t2.micro
    AllowedValues:
      - t1.micro
      - t2.micro
    ConstraintDescription: >-
      Only t1.micro or t2.micro is available (Due to costs).

Mappings:
  #Just a handful of regions too many to list but additional entries can be added as needed.
  #Can be overridden by using the EC2ImageId parameter.
  #These are free tier AMIs if using the t1.micro or t2.micro instance types.
  AMIRegionImage:
    eu-west-1: #Ireland
      AMIId: "ami-0ee415e1b8b71305f"
    eu-central-1: #Frankfurt
      AMIId: "ami-070b208e993b59cea"
    us-east-1: #N. Virginia
      AMIId: "ami-09d3b3274b6c5d4aa"
    us-east-2: #Ohio
      AMIId: "ami-089a545a9ed9893b6"
    us-west-1: #N. California
      AMIId: "ami-017c001a88dd93847"
    us-west-2: #Oregon
      AMIId: "ami-0d593311db5abb72b"
  
Conditions:
  FindAMIByRegion: !Equals [ !Ref EC2ImageId, "" ] #Condition to use the Mapping instead of the passed in value

Resources:
  #Our VPC stack.
  #This will output a VPC Id reference and an InternetGateway Id reference.
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Ref VPCTemplateURL
      Parameters:
        VPCCidrBlock: 10.10.0.0/16

  #The first public subnet.
  #This subnet will create the the NAT Gateway to be used by the private subnets.
  #This NAT Gateway will be returned as an output.
  PublicSubnet1:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Ref SubnetTemplateURL
      Parameters:
        SubnetType: public
        VPCReference: !GetAtt VPCStack.Outputs.VPCReference
        InternetGatewayReference: !GetAtt VPCStack.Outputs.InternetGatewayReference
        SelectAZ: 1
        CreateNATAndEIP: true
        SubnetCidrBlock: 10.10.3.0/24
        RouteCidrBlock: 0.0.0.0/0


  #This private subnet will return a reference to its created NAT Gateway
  PrivateSubnet1:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Ref SubnetTemplateURL
      Parameters:
        SubnetType: private
        VPCReference: !GetAtt VPCStack.Outputs.VPCReference
        NATGatewayReference: !GetAtt PublicSubnet1.Outputs.StackNATGateway
        SelectAZ: 0
        CreateNATAndEIP: false #Only build the NAT for this one to save on costs
        SubnetCidrBlock: 10.10.1.0/24
        RouteCidrBlock: 0.0.0.0/0

  #Our subnet stack
  PrivateSubnet2:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Ref SubnetTemplateURL
      Parameters:
        SubnetType: private
        VPCReference: !GetAtt VPCStack.Outputs.VPCReference
        NATGatewayReference: !GetAtt PublicSubnet1.Outputs.StackNATGateway
        SelectAZ: 0
        CreateNATAndEIP: false
        SubnetCidrBlock: 10.10.2.0/24
        RouteCidrBlock: 0.0.0.0/0

  #Our subnet stack
  PublicSubnet2:
    Type: AWS::CloudFormation::Stack
    DependsOn: VPCStack
    Properties:
      TemplateURL: !Ref SubnetTemplateURL
      Parameters:
        SubnetType: public
        VPCReference: !GetAtt VPCStack.Outputs.VPCReference
        InternetGatewayReference: !GetAtt VPCStack.Outputs.InternetGatewayReference
        SelectAZ: 1
        CreateNATAndEIP: false
        SubnetCidrBlock: 10.10.4.0/24
        RouteCidrBlock: 0.0.0.0/0

  #Need to enable SSH access for resources that require it.
  SSHPublicSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DependsOn: VPCStack
    Properties:
      GroupName: !Join ['-', ["SecurityGroup", "SSH", !Ref "AWS::StackName"]]
      GroupDescription: Enable SSH via port 22 access 
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: 22
          IpProtocol: tcp
          ToPort: 22
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      VpcId: !GetAtt VPCStack.Outputs.VPCReference

  #The EC2 Jump Box. This will be used to SSH from the public subnet into the private subnet.
  EC2JumpBox:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !If [ FindAMIByRegion, !FindInMap [ AMIRegionImage, !Ref "AWS::Region", AMIId ], !Ref EC2ImageId ] #Find a suitable AMI based on the region, override with passed in AMI
      KeyName: !Ref SSHKeyJumpBox #Needed to authenticate onto this EC2 instance via SSH
      InstanceType: !Ref EC2InstanceType
      NetworkInterfaces:
      - DeviceIndex: '0'
        SubnetId: !GetAtt PublicSubnet1.Outputs.StackSubnet
        AssociatePublicIpAddress: true #ensure it has an public facing IP Address
        GroupSet: [ !Ref SSHPublicSecurityGroup ]
      
      Tags:
        - Key: Name
          Value: !Join ['-', ["EC2", "JumpBox", !Ref "AWS::StackName"]]

  #The EC2 application hosted in the private subnet
  EC2Application:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !If [ FindAMIByRegion, !FindInMap [ AMIRegionImage, !Ref "AWS::Region", AMIId ], !Ref EC2ImageId ] #Find a suitable AMI based on the region, override with passed in AMI
      KeyName: !Ref SSHKeyApplication #Needed to authenticate onto this EC2 instance via SSH
      InstanceType: !Ref EC2InstanceType
      NetworkInterfaces:
      - DeviceIndex: '0'
        SubnetId: !GetAtt PrivateSubnet1.Outputs.StackSubnet
        AssociatePublicIpAddress: false
        GroupSet: [ !Ref SSHPublicSecurityGroup ] 
      Tags:
        - Key: Name
          Value: !Join ['-', ["EC2", "Application", !Ref "AWS::StackName"]]

  #Front end hosted in the public subnet
  EC2FrontEnd:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !If [ FindAMIByRegion, !FindInMap [ AMIRegionImage, !Ref "AWS::Region", AMIId ], !Ref EC2ImageId ] #Find a suitable AMI based on the region, override with passed in AMI
      KeyName: !Ref SSHKeyFrontEnd #Needed to authenticate onto this EC2 instance via SSH
      InstanceType: !Ref EC2InstanceType
      NetworkInterfaces:
      - DeviceIndex: '0'
        SubnetId: !GetAtt PublicSubnet2.Outputs.StackSubnet
        AssociatePublicIpAddress: true #ensure it has an public facing IP Address
        GroupSet: [ !Ref SSHPublicSecurityGroup ]
      Tags:
        - Key: Name
          Value: !Join ['-', ["EC2", "FrontEnd", !Ref "AWS::StackName"]]

  #The EC2 application hosted in the private subnet
  EC2Database:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !If [ FindAMIByRegion, !FindInMap [ AMIRegionImage, !Ref "AWS::Region", AMIId ], !Ref EC2ImageId ]
      KeyName: !Ref SSHKeyDatabase #Needed to authenticate onto this EC2 instance via SSH
      InstanceType: !Ref EC2InstanceType
      NetworkInterfaces:
      - DeviceIndex: '0'
        SubnetId: !GetAtt PrivateSubnet2.Outputs.StackSubnet
        AssociatePublicIpAddress: false
        GroupSet: [ !Ref SSHPublicSecurityGroup ] 
      Tags:
        - Key: Name
          Value: !Join ['-', ["EC2", "Database", !Ref "AWS::StackName"]]